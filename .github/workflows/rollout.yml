name: Creating resources...
on: {                                                                   #starting...
    workflow_dispatch: {},                                              #on button "Run workflow"
}

permissions: {                                                          #minimum permissions
    id-token: write,                                                    #for OIDC login (without saving keys)
    contents: read                                                      #to read repo
}

jobs:
  rollout:
    runs-on: ubuntu-latest                                              #Linux VM
    defaults: { 
        run: { 
            working-directory: terraform                                #every run command will be done in terraform/ (where we have .tf files)
        } 
    }
    
    steps:
      - uses: actions/checkout@v4                                       #checkout repo on runner
      - uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      - uses: hashicorp/setup-terraform@v3                              #installing terraform CLI
      - run: terraform init -input=false -reconfigure                   #initializing a Terraform working dir
      - run: terraform plan -out=tfplan -input=false -var="ssh_public_key_value=${{ secrets.SSH_PUBLIC_KEY }}"     #planing what will be created
      - run: terraform apply -input=false -auto-approve tfplan          #creating infrastructure
      - name: Outputs
        run: terraform output
